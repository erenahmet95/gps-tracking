<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Vehicle and Photo Map</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- ExifReader.js for reading EXIF data -->
    <script src="https://cdn.jsdelivr.net/npm/exifreader/dist/exif-reader.min.js"></script>
    <!-- Photo files list -->
    <script src="photos.js"></script>
</head>
<body>
    <h1>Dynamic Vehicle and Photo Map</h1>
    <div id="map"></div>

    <script>
        // Mapbox API Key
        const MAPBOX_API_KEY = 'pk.eyJ1IjoiZXJlbmFobWV0OTUiLCJhIjoiY2x3czZnZm1yMDBkNDJrcXo0bW93OTlsdCJ9.w-qOTb7nP3H2kC5FhzdXLg';

        // Başlangıçta haritayı oluşturma
        var map = L.map('map').setView([51.48821, 8.30442], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Araç marker'ını oluşturma
        var vehicleMarker = L.marker([51.48821, 8.30442], {
            icon: L.icon({
                iconUrl: 'https://leafletjs.com/examples/custom-icons/leaf-green.png',
                shadowUrl: 'https://leafletjs.com/examples/custom-icons/leaf-shadow.png',

                iconSize:     [38, 95], // icon boyutu
                shadowSize:   [50, 64], // gölge boyutu
                iconAnchor:   [22, 94], // icon'un haritadaki konumunu belirleyen nokta
                shadowAnchor: [4, 62],  // gölge konumu
                popupAnchor:  [-3, -76] // popup'un icon konumuna göre açılma noktası
            })
        }).addTo(map);

        // Sunucu URL'sini belirtin
        const serverURL = 'https://erenahmet95.github.io/gps-tracking'; // GitHub Pages URL'nizi ekleyin

        // Fotoğraf bilgilerini okuma ve haritaya ekleme
        photoFiles.forEach(photoFile => {
            const imagePath = `${serverURL}/${photoFile}`; // Doğru URL formatını kullan

            fetch(imagePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Fotoğraf yükleme hatası: ' + response.statusText);
                    }
                    return response.blob();
                })
                .then(blob => {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const tags = ExifReader.load(event.target.result);

                        // EXIF verilerini okuma
                        const gpsLatitude = tags['GPSLatitude'];
                        const gpsLongitude = tags['GPSLongitude'];
                        const dateTaken = tags['DateTimeOriginal'];

                        // Konsola EXIF verilerini yazdırma
                        console.log(`Fotoğraf: ${photoFile}`);
                        console.log(`EXIF GPSLatitude: ${gpsLatitude ? gpsLatitude.description : "Bulunamadı"}`);
                        console.log(`EXIF GPSLongitude: ${gpsLongitude ? gpsLongitude.description : "Bulunamadı"}`);
                        console.log(`EXIF Date Taken: ${dateTaken ? dateTaken.description : "Bulunamadı"}`);

                        if (!gpsLatitude || !gpsLongitude) {
                            console.log("Koordinatlar bulunamadı.");
                            return;
                        }

                        // Koordinatları derecelere çevirme
                        const lat = convertToDegrees(gpsLatitude);
                        const lon = convertToDegrees(gpsLongitude);

                        console.log(`Koordinatlar: Latitude = ${lat}, Longitude = ${lon}`);

                        // Fotoğrafı base64 formatına dönüştürme
                        const imgBase64 = event.target.result.split(',')[1];

                        // Koordinatlara göre adres bilgisi alma
                        getAddressFromCoordinates(lat, lon)
                            .then(address => {
                                const popupContent = `
                                    <div>
                                        <a href="data:image/jpeg;base64,${imgBase64}" target="_blank">
                                            <img src="data:image/jpeg;base64,${imgBase64}" width="100px" height="100px">
                                        </a>
                                        <p><b>Address:</b> ${address}</p>
                                        <p><b>Date:</b> ${dateTaken ? dateTaken.description : "Date not found"}</p>
                                    </div>
                                `;
                                L.marker([lat, lon]).addTo(map)
                                    .bindPopup(popupContent);
                            })
                            .catch(error => console.error('Adres alma hatası:', error));
                    };
                    reader.readAsArrayBuffer(blob);  // Doğru format kullanılıyor
                })
                .catch(error => console.error('Fotoğraf yükleme hatası:', error));
        });

        // Dereceye çevirme fonksiyonu
        function convertToDegrees(value) {
            const degrees = value.value[0].numerator / value.value[0].denominator;
            const minutes = value.value[1].numerator / value.value[1].denominator;
            const seconds = value.value[2].numerator / value.value[2].denominator;

            return degrees + (minutes / 60) + (seconds / 3600);
        }

        // Koordinatlara göre adres bilgisi alma fonksiyonu
        function getAddressFromCoordinates(lat, lon) {
            return fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lon},${lat}.json?access_token=${MAPBOX_API_KEY}`)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        return data.features[0].place_name;
                    }
                    return 'Address not found';
                });
        }

        // Araç konumunu güncelleyen fonksiyon
        function updateVehicleLocation() {
            fetch('http://localhost:5000/api/vehicle-location')  // Flask API adresi
                .then(response => response.json())
                .then(data => {
                    var newLat = data.latitude;
                    var newLng = data.longitude;
                    vehicleMarker.setLatLng([newLat, newLng]);
                    map.setView([newLat, newLng], map.getZoom());  // Haritayı güncel konuma odakla
                    console.log("Updated vehicle position:", newLat, newLng); // Konsola yeni konumu yazdır
                })
                .catch(error => console.error('Araç konumunu güncelleme hatası:', error));
        }

        // Konumu güncelle ve her 5 saniyede bir güncelle
        updateVehicleLocation();
        setInterval(updateVehicleLocation, 5000);  // Her 5 saniyede bir konumu günceller

    </script>
</body>
</html>
